#include "tbai_ros_core/control/StateSubscriber.hpp"

namespace tbai {

/*********************************************************************************************************************/
/*********************************************************************************************************************/
/*********************************************************************************************************************/
RosStateSubscriber::RosStateSubscriber(ros::NodeHandle &nh, const std::string &stateTopic) {
    stateSubscriber_ = nh.subscribe(stateTopic, 1, &RosStateSubscriber::stateMessageCallback, this);
}

/*********************************************************************************************************************/
/*********************************************************************************************************************/
/*********************************************************************************************************************/
void RosStateSubscriber::waitTillInitialized() {
    while (!stateMessage_ && ros::ok()) {
        ros::spinOnce();
        ros::Duration(0.05).sleep();
        ROS_INFO_STREAM_THROTTLE(1, "[StateSubscriber] Waiting for state message...");
    }
}

/*********************************************************************************************************************/
/*********************************************************************************************************************/
/*********************************************************************************************************************/
void RosStateSubscriber::updateLatestRbdState() {
    latestRbdState_ = vector_t(Eigen::Map<vector_t>(stateMessage_->rbd_state.data(), stateMessage_->rbd_state.size()));
}

/*********************************************************************************************************************/
/*********************************************************************************************************************/
/*********************************************************************************************************************/
const vector_t &RosStateSubscriber::getLatestRbdState() {
    if (!stateReady_) {
        updateLatestRbdState();
        stateReady_ = true;
    }
    return latestRbdState_;
}

/*********************************************************************************************************************/
/*********************************************************************************************************************/
/*********************************************************************************************************************/
void RosStateSubscriber::stateMessageCallback(const tbai_ros_msgs::RbdState::Ptr &msg) {
    stateMessage_ = msg;
    stateReady_ = false;
}

}  // namespace tbai
